<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Martingale Paper Trader Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f1117; color: #e0e0e0; padding: 20px; }
h1 { color: #fff; margin-bottom: 5px; font-size: 1.6em; }
.subtitle { color: #888; margin-bottom: 20px; font-size: 0.9em; }
.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 20px; }
.card { background: #1a1d28; border-radius: 12px; padding: 20px; border: 1px solid #2a2d3a; }
.card h3 { color: #aaa; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
.big-num { font-size: 2em; font-weight: 700; }
.green { color: #00d68f; } .red { color: #ff4d6a; } .yellow { color: #ffaa00; } .blue { color: #4da6ff; }
.sub { color: #888; font-size: 0.85em; margin-top: 4px; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; color: #888; font-size: 0.8em; text-transform: uppercase; padding: 8px 12px; border-bottom: 1px solid #2a2d3a; }
td { padding: 8px 12px; border-bottom: 1px solid #1e2130; font-size: 0.9em; }
tr:hover { background: #1e2130; }
.regime-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; display: inline-block; }
.regime-CHOPPY, .regime-ACCUMULATION, .regime-RANGING { background: #00d68f22; color: #00d68f; }
.regime-MILD_TREND, .regime-DISTRIBUTION { background: #ffaa0022; color: #ffaa00; }
.regime-TRENDING, .regime-EXTREME, .regime-BREAKOUT_WARNING { background: #ff4d6a22; color: #ff4d6a; }
.cb-ok { color: #00d68f; } .cb-triggered { color: #ff4d6a; font-weight: 700; }
canvas { width: 100%; height: 200px; }
#status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
#last-update { color: #666; font-size: 0.85em; }
#load-error { display: none; background: #ff4d6a22; color: #ff4d6a; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
.no-data { color: #666; text-align: center; padding: 40px; }
</style>
</head>
<body>
<div id="status-bar">
  <div><h1>ðŸ¤– Martingale Paper Trader</h1><div class="subtitle">Live Dashboard â€” auto-refreshes every 30s</div></div>
  <div id="last-update">Loading...</div>
</div>
<div id="load-error"></div>

<div class="grid" id="summary-cards"></div>

<div class="card" style="margin-bottom:20px">
  <h3>Equity Curve</h3>
  <canvas id="equity-chart"></canvas>
</div>

<div class="grid" style="grid-template-columns: 1fr 1fr;">
  <div class="card">
    <h3>Open Deals</h3>
    <div id="open-deals"><div class="no-data">No open deals</div></div>
  </div>
  <div class="card">
    <h3>Regimes</h3>
    <div id="regimes"><div class="no-data">No data</div></div>
  </div>
</div>

<div class="card" style="margin-top:20px">
  <h3>Recent Closed Deals</h3>
  <div id="closed-deals"><div class="no-data">No closed deals yet</div></div>
</div>

<script>
const STATUS_URL = 'status.json';
let chart = null;

function fmt(n, d=2) { return n != null ? Number(n).toFixed(d) : 'â€”'; }
function fmtUSD(n) { return n != null ? '$' + Number(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}) : 'â€”'; }
function pnlClass(n) { return n >= 0 ? 'green' : 'red'; }

function renderSummary(s) {
  document.getElementById('summary-cards').innerHTML = `
    <div class="card"><h3>Equity</h3><div class="big-num blue">${fmtUSD(s.equity)}</div><div class="sub">Initial: ${fmtUSD(s.initial_capital)} | Cash: ${fmtUSD(s.cash)}</div></div>
    <div class="card"><h3>PnL</h3><div class="big-num ${pnlClass(s.pnl)}">${fmtUSD(s.pnl)} (${fmt(s.pnl_pct)}%)</div><div class="sub">Peak: ${fmtUSD(s.peak_equity)}</div></div>
    <div class="card"><h3>Drawdown</h3><div class="big-num ${s.drawdown_pct > 15 ? 'red' : s.drawdown_pct > 8 ? 'yellow' : 'green'}">${fmt(s.drawdown_pct)}%</div><div class="sub">Threshold: ${s.max_drawdown_threshold}%</div></div>
    <div class="card"><h3>Circuit Breaker</h3><div class="big-num ${s.circuit_breaker ? 'cb-triggered' : 'cb-ok'}">${s.circuit_breaker ? 'ðŸ”´ TRIGGERED' : 'ðŸŸ¢ OK'}</div><div class="sub">${s.timeframe} | ${s.use_v2_regime ? 'v2 Regime' : 'v1 Regime'} | Deals: ${s.open_deals?.length||0} open / ${s.closed_deals_count||0} closed</div></div>
  `;
}

function renderOpenDeals(deals) {
  if (!deals || !deals.length) { document.getElementById('open-deals').innerHTML = '<div class="no-data">No open deals</div>'; return; }
  let h = '<table><tr><th>#</th><th>Symbol</th><th>Entry</th><th>Price</th><th>SOs</th><th>Invested</th><th>uPnL</th></tr>';
  deals.forEach(d => {
    h += `<tr><td>${d.deal_id}</td><td>${d.symbol}</td><td>$${fmt(d.avg_entry,4)}</td><td>$${fmt(d.current_price,4)}</td><td>${d.so_count}</td><td>${fmtUSD(d.invested)}</td><td class="${pnlClass(d.unrealized_pnl)}">${fmtUSD(d.unrealized_pnl)}</td></tr>`;
  });
  document.getElementById('open-deals').innerHTML = h + '</table>';
}

function renderRegimes(regimes) {
  if (!regimes || !Object.keys(regimes).length) { document.getElementById('regimes').innerHTML = '<div class="no-data">No data</div>'; return; }
  let h = '<table><tr><th>Symbol</th><th>Regime</th></tr>';
  for (const [sym, reg] of Object.entries(regimes)) {
    h += `<tr><td>${sym}</td><td><span class="regime-badge regime-${reg}">${reg}</span></td></tr>`;
  }
  document.getElementById('regimes').innerHTML = h + '</table>';
}

function renderClosedDeals(deals) {
  if (!deals || !deals.length) { document.getElementById('closed-deals').innerHTML = '<div class="no-data">No closed deals yet</div>'; return; }
  let h = '<table><tr><th>#</th><th>Symbol</th><th>Entry</th><th>Close</th><th>SOs</th><th>PnL</th><th>Closed</th></tr>';
  deals.slice().reverse().forEach(d => {
    h += `<tr><td>${d.deal_id}</td><td>${d.symbol}</td><td>$${fmt(d.avg_entry,4)}</td><td>$${fmt(d.close_price,4)}</td><td>${d.so_count}</td><td class="${pnlClass(d.pnl)}">${fmtUSD(d.pnl)}</td><td>${(d.close_time||'').slice(0,16)}</td></tr>`;
  });
  document.getElementById('closed-deals').innerHTML = h + '</table>';
}

function renderChart(history) {
  const canvas = document.getElementById('equity-chart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * 2; canvas.height = 400;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!history || history.length < 2) { ctx.fillStyle='#666'; ctx.font='28px sans-serif'; ctx.fillText('Waiting for data...', 40, 200); return; }

  const vals = history.map(e => e.equity);
  const mn = Math.min(...vals) * 0.998, mx = Math.max(...vals) * 1.002;
  const w = canvas.width, h = canvas.height, pad = 60;

  // Grid
  ctx.strokeStyle = '#1e2130'; ctx.lineWidth = 1;
  for (let i = 0; i < 5; i++) {
    const y = pad + (h - 2*pad) * i / 4;
    ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w - 20, y); ctx.stroke();
    ctx.fillStyle = '#666'; ctx.font = '20px sans-serif';
    ctx.fillText('$' + (mx - (mx-mn)*i/4).toFixed(0), 0, y + 6);
  }

  // Line
  ctx.beginPath(); ctx.strokeStyle = '#4da6ff'; ctx.lineWidth = 2.5;
  vals.forEach((v, i) => {
    const x = pad + (w - pad - 20) * i / (vals.length - 1);
    const y = pad + (h - 2*pad) * (1 - (v - mn) / (mx - mn || 1));
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Fill
  const lastX = pad + (w - pad - 20);
  ctx.lineTo(lastX, h - pad); ctx.lineTo(pad, h - pad); ctx.closePath();
  ctx.fillStyle = 'rgba(77,166,255,0.08)'; ctx.fill();
}

async function refresh() {
  try {
    const r = await fetch(STATUS_URL + '?t=' + Date.now());
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const s = await r.json();
    document.getElementById('load-error').style.display = 'none';
    document.getElementById('last-update').textContent = 'Updated: ' + new Date(s.timestamp).toLocaleString();
    renderSummary(s);
    renderOpenDeals(s.open_deals);
    renderRegimes(s.regimes);
    renderClosedDeals(s.closed_deals_recent);
    renderChart(s.equity_history);
  } catch(e) {
    document.getElementById('load-error').style.display = 'block';
    document.getElementById('load-error').textContent = 'Failed to load status: ' + e.message + '. Is the paper trader running?';
  }
}

refresh();
setInterval(refresh, 30000);
</script>
</body>
</html>
