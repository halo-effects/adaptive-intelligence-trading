<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gee Gee Voice</title>
<style>
:root {
  --bg: #0d1117; --card: #161b22; --border: #30363d;
  --green: #3fb950; --red: #f85149; --blue: #58a6ff;
  --text: #e6edf3; --text2: #8b949e;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; }
header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
header h1 { font-size: 20px; font-weight: 600; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--text2); transition: background 0.3s; }
.status-dot.connected { background: var(--green); }
.status-dot.recording { background: var(--red); animation: pulse-dot 1s infinite; }
.status-dot.thinking { background: var(--blue); animation: pulse-dot 0.6s infinite; }
.status-label { font-size: 13px; color: var(--text2); }

.main { flex: 1; display: flex; flex-direction: column; align-items: center; overflow: hidden; }

.mic-area { padding: 40px 0 20px; display: flex; flex-direction: column; align-items: center; gap: 16px; flex-shrink: 0; }
.mic-btn {
  width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--border);
  background: var(--card); cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; position: relative;
}
.mic-btn:hover { border-color: var(--blue); transform: scale(1.05); }
.mic-btn.active { border-color: var(--red); background: rgba(248,81,73,0.15); }
.mic-btn.active .mic-icon { fill: var(--red); }
.mic-btn.thinking { border-color: var(--blue); }
.mic-btn.speaking { border-color: var(--green); }

.mic-ring {
  position: absolute; inset: -8px; border-radius: 50%; border: 2px solid transparent; transition: border-color 0.3s;
}
.mic-btn.active .mic-ring { border-color: var(--red); animation: pulse-ring 1.5s infinite; }
.mic-btn.thinking .mic-ring { border-color: var(--blue); animation: pulse-ring 0.8s infinite; }
.mic-btn.speaking .mic-ring { border-color: var(--green); animation: pulse-ring 1.2s infinite; }

.mic-icon { width: 48px; height: 48px; fill: var(--text2); transition: fill 0.2s; }
.mic-hint { font-size: 13px; color: var(--text2); }

.transcript-box {
  width: 90%; max-width: 600px; min-height: 48px; padding: 12px 16px;
  background: var(--card); border: 1px solid var(--border); border-radius: 12px;
  font-size: 15px; color: var(--text); text-align: center; margin-bottom: 12px; flex-shrink: 0;
}
.transcript-box.interim { color: var(--text2); font-style: italic; }
.transcript-box:empty::before { content: 'Tap the mic and speak...'; color: var(--text2); font-size: 13px; }

.history {
  flex: 1; width: 100%; max-width: 640px; overflow-y: auto; padding: 8px 20px 20px;
  display: flex; flex-direction: column; gap: 12px;
}
.msg { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; max-width: 85%; word-wrap: break-word; white-space: pre-wrap; }
.msg.user { background: rgba(88,166,255,0.15); color: var(--blue); align-self: flex-end; border-bottom-right-radius: 4px; }
.msg.bot { background: var(--card); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }
.msg.bot .meta { font-size: 11px; color: var(--text2); margin-bottom: 4px; }

@keyframes pulse-ring { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.12); } }
@keyframes pulse-dot { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
</style>
</head>
<body>

<header>
  <h1>üéôÔ∏è Gee Gee Voice</h1>
  <div class="status-dot connected" id="statusDot"></div>
  <span class="status-label" id="statusLabel">Ready</span>
</header>

<div class="main">
  <div class="mic-area">
    <button class="mic-btn" id="micBtn" onclick="toggleMic()">
      <div class="mic-ring"></div>
      <svg class="mic-icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
    </button>
    <div class="mic-hint" id="micHint">Tap to speak</div>
  </div>
  <div class="transcript-box" id="transcript"></div>
  <div class="history" id="history"></div>
</div>

<script>
const BOT_TOKEN = '8528958079:AAF90HSJ5Ck1urUydzS5CUvyf2EEeB7LUwc';
const CHAT_ID = '5221941584';
const API = `https://api.telegram.org/bot${BOT_TOKEN}`;

const micBtn = document.getElementById('micBtn');
const transcript = document.getElementById('transcript');
const history = document.getElementById('history');
const statusDot = document.getElementById('statusDot');
const statusLabel = document.getElementById('statusLabel');
const micHint = document.getElementById('micHint');

let recognition = null;
let isListening = false;
let lastUpdateId = 0;
let currentTranscript = '';

// Init: get latest update_id so we ignore old messages
(async () => {
  try {
    const r = await fetch(`${API}/getUpdates?offset=-1`);
    const d = await r.json();
    if (d.ok && d.result.length) lastUpdateId = d.result[d.result.length - 1].update_id;
  } catch(e) {}
})();

function setStatus(state, text) {
  statusDot.className = 'status-dot ' + state;
  statusLabel.textContent = text;
}

function addMsg(text, type) {
  const d = document.createElement('div');
  d.className = 'msg ' + type;
  d.textContent = text;
  history.appendChild(d);
  history.scrollTop = history.scrollHeight;
}

function toggleMic() {
  if (isListening) { stopListening(); return; }
  startListening();
}

function startListening() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert('Speech Recognition not supported. Use Chrome.'); return; }

  recognition = new SR();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onstart = () => {
    isListening = true;
    micBtn.className = 'mic-btn active';
    micHint.textContent = 'Listening...';
    setStatus('recording', 'Listening');
    transcript.textContent = '';
    transcript.className = 'transcript-box interim';
    currentTranscript = '';
  };

  recognition.onresult = (e) => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    if (final) { currentTranscript += final; transcript.className = 'transcript-box'; }
    transcript.textContent = currentTranscript + interim;
  };

  recognition.onend = () => {
    isListening = false;
    micBtn.className = 'mic-btn';
    micHint.textContent = 'Tap to speak';
    if (currentTranscript.trim()) {
      transcript.className = 'transcript-box';
      transcript.textContent = currentTranscript.trim();
      sendMessage(currentTranscript.trim());
    } else {
      setStatus('connected', 'Ready');
    }
  };

  recognition.onerror = (e) => {
    isListening = false;
    micBtn.className = 'mic-btn';
    micHint.textContent = 'Tap to speak';
    if (e.error !== 'no-speech') setStatus('connected', 'Error: ' + e.error);
    else setStatus('connected', 'Ready');
  };

  recognition.start();
}

function stopListening() {
  if (recognition) recognition.stop();
}

async function sendMessage(text) {
  addMsg(text, 'user');
  setStatus('thinking', 'Sending...');
  micBtn.className = 'mic-btn thinking';
  micHint.textContent = 'Waiting for Gee Gee...';

  try {
    await fetch(`${API}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: CHAT_ID, text })
    });
    pollForResponse();
  } catch(e) {
    setStatus('connected', 'Send failed');
    micBtn.className = 'mic-btn';
    micHint.textContent = 'Tap to speak';
  }
}

async function pollForResponse() {
  setStatus('thinking', 'Thinking...');
  const start = Date.now();
  const poll = async () => {
    if (Date.now() - start > 60000) {
      setStatus('connected', 'Timeout');
      micBtn.className = 'mic-btn';
      micHint.textContent = 'Tap to speak';
      return;
    }
    try {
      const r = await fetch(`${API}/getUpdates?offset=${lastUpdateId + 1}&timeout=2`);
      const d = await r.json();
      if (d.ok && d.result.length) {
        for (const u of d.result) {
          lastUpdateId = u.update_id;
          const m = u.message || u.channel_post;
          if (m && m.from && m.from.is_bot && m.chat && String(m.chat.id) === CHAT_ID && m.text) {
            // Got bot response
            const responseText = m.text;
            addMsg(responseText, 'bot');
            transcript.textContent = '';
            speakResponse(responseText);
            return;
          }
        }
      }
    } catch(e) {}
    setTimeout(poll, 1000);
  };
  poll();
}

function speakResponse(text) {
  setStatus('speaking', 'Speaking...');
  micBtn.className = 'mic-btn speaking';
  micHint.textContent = 'Speaking...';

  // Clean markdown-ish stuff for speech
  const clean = text.replace(/[*_`#\[\]()]/g, '').replace(/https?:\/\/\S+/g, 'link');
  const utter = new SpeechSynthesisUtterance(clean);
  utter.rate = 1.05;
  utter.pitch = 1;

  // Try to pick a nice voice
  const voices = speechSynthesis.getVoices();
  const preferred = voices.find(v => /samantha|karen|google us english|microsoft zira/i.test(v.name))
    || voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('female'))
    || voices.find(v => v.lang.startsWith('en'));
  if (preferred) utter.voice = preferred;

  utter.onend = () => {
    setStatus('connected', 'Ready');
    micBtn.className = 'mic-btn';
    micHint.textContent = 'Tap to speak';
  };
  utter.onerror = utter.onend;
  speechSynthesis.speak(utter);
}

// Preload voices
speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
</script>
</body>
</html>
